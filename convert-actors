/**
 * Dragonbane Actor Type Converter
 *
 * This macro allows you to convert between Character, NPC, and Monster actor types.
 * It will transfer all compatible data fields and all items to the new actor.
 *
 * Usage: Select a single actor token, then run this macro.
 */

(async () => {
  // Check if a single actor is selected
  const tokens = canvas.tokens.controlled;
  if (tokens.length !== 1) {
    ui.notifications.warn("Please select exactly one token/actor to convert.");
    return;
  }

  const actor = tokens[0].actor;
  if (!actor) {
    ui.notifications.error("Selected token has no associated actor.");
    return;
  }

  const currentType = actor.type;
  const validTypes = ["character", "npc", "monster"];

  if (!validTypes.includes(currentType)) {
    ui.notifications.error(
      `Selected actor type "${currentType}" is not supported for conversion.`
    );
    return;
  }

  // Determine available conversion targets
  const targetTypes = validTypes.filter((t) => t !== currentType);

  // Build the dialog content
  let dialogContent = `
        <form>
            <div class="form-group">
                <label><strong>Current Actor Type:</strong> ${
                  currentType === "npc"
                    ? "NPC"
                    : currentType.charAt(0).toUpperCase() + currentType.slice(1)
                }</label>
            </div>
            <div class="form-group">
                <label><strong>Current Actor Name:</strong> ${
                  actor.name
                }</label>
            </div>
            <div class="form-group">
                <label><strong>Convert to:</strong></label>
                <select name="targetType" id="targetType">
                    ${targetTypes
                      .map((t) => {
                        const displayName =
                          t === "npc"
                            ? "NPC"
                            : t.charAt(0).toUpperCase() + t.slice(1);
                        return `<option value="${t}">${displayName}</option>`;
                      })
                      .join("")}
                </select>
            </div>
            <div class="form-group">
                <label><strong>New Actor Name:</strong></label>
                <input type="text" name="newName" value="${
                  actor.name
                }" style="width: 100%"/>
            </div>
            <div id="conversionFields" style="min-height: 95px;"></div>
        </form>
    `;

  // Create the dialog
  new Dialog(
    {
      title: "Convert Actor Type",
      content: dialogContent,
      buttons: {
        convert: {
          icon: '<i class="fas fa-exchange-alt"></i>',
          label: "Convert",
          callback: async (html) => {
            const targetType = html.find('[name="targetType"]').val();
            const newName = html.find('[name="newName"]').val();

            // Get conversion-specific values if present
            let conversionData = {};

            if (targetType === "monster") {
              const ferocity =
                parseInt(html.find('[name="ferocity"]').val()) || 1;
              const size = html.find('[name="size"]').val() || "normal";
              const armor = parseInt(html.find('[name="armor"]').val()) || 0;
              conversionData.ferocity = ferocity;
              conversionData.size = size;
              conversionData.armor = armor;
            } else if (currentType === "monster") {
              if (targetType === "character") {
                // Converting Monster → Character: get attributes
                conversionData.attributes = {
                  str: parseInt(html.find('[name="str"]').val()) || 10,
                  con: parseInt(html.find('[name="con"]').val()) || 10,
                  agl: parseInt(html.find('[name="agl"]').val()) || 10,
                  int: parseInt(html.find('[name="int"]').val()) || 10,
                  wil: parseInt(html.find('[name="wil"]').val()) || 10,
                  cha: parseInt(html.find('[name="cha"]').val()) || 10,
                };
              } else if (targetType === "npc") {
                // Converting Monster → NPC: get attributes for WP calculation and damage bonuses
                conversionData.wil =
                  parseInt(html.find('[name="wil"]').val()) || 10;
                conversionData.damageBonus = {
                  str:
                    html.find('[name="damageBonusStr"]').val() ||
                    "DoD.dice.none",
                  agl:
                    html.find('[name="damageBonusAgl"]').val() ||
                    "DoD.dice.none",
                };
              }
            }

            await convertActor(actor, targetType, newName, conversionData);
          },
        },
        cancel: {
          icon: '<i class="fas fa-times"></i>',
          label: "Cancel",
        },
      },
      default: "convert",
      render: (html) => {
        // Add dynamic fields based on target type selection
        const updateFields = () => {
          const targetType = html.find('[name="targetType"]').val();
          const fieldsDiv = html.find("#conversionFields");
          fieldsDiv.empty();

          if (targetType === "monster") {
            fieldsDiv.append(`
                        <div class="form-group">
                            <label><strong>Ferocity Value:</strong></label>
                            <input type="number" name="ferocity" value="1" min="1" style="width: 100%"/>
                        </div>
                        <div class="form-group">
                            <label><strong>Size:</strong></label>
                            <select name="size" style="width: 100%">
                                <option value="small">Small</option>
                                <option value="normal" selected>Normal</option>
                                <option value="large">Large</option>
                                <option value="huge">Huge</option>
                                <option value="swarm">Swarm</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><strong>Armor Rating:</strong></label>
                            <input type="number" name="armor" value="0" min="0" style="width: 100%"/>
                        </div>
                    `);
          } else if (currentType === "monster") {
            // Converting FROM monster
            if (targetType === "character") {
              // Monster → Character: need all attributes
              fieldsDiv.append(`
                            <div class="form-group">
                                <label><strong>Set Attributes:</strong></label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                                    <div>
                                        <label style="display: inline-block; width: 40px;">STR:</label>
                                        <input type="number" name="str" value="10" min="1" max="18" style="width: 50%; text-align: center;"/>
                                    </div>
                                    <div>
                                        <label style="display: inline-block; width: 40px;">CON:</label>
                                        <input type="number" name="con" value="10" min="1" max="18" style="width: 50%; text-align: center;"/>
                                    </div>
                                    <div>
                                        <label style="display: inline-block; width: 40px;">AGL:</label>
                                        <input type="number" name="agl" value="10" min="1" max="18" style="width: 50%; text-align: center;"/>
                                    </div>
                                    <div>
                                        <label style="display: inline-block; width: 40px;">INT:</label>
                                        <input type="number" name="int" value="10" min="1" max="18" style="width: 50%; text-align: center;"/>
                                    </div>
                                    <div>
                                        <label style="display: inline-block; width: 40px;">WIL:</label>
                                        <input type="number" name="wil" value="10" min="1" max="18" style="width: 50%; text-align: center;"/>
                                    </div>
                                    <div>
                                        <label style="display: inline-block; width: 40px;">CHA:</label>
                                        <input type="number" name="cha" value="10" min="1" max="18" style="width: 50%; text-align: center;"/>
                                    </div>
                                </div>
                            </div>
                        `);
            } else if (targetType === "npc") {
              // Monster → NPC: need WIL for WP and damage bonuses
              fieldsDiv.append(`
                            <div class="form-group">
                                <label><strong>Set Willpower:</strong></label>
                                <input type="number" name="wil" value="10" min="1" max="18" style="width: 100%"/>
                            </div>
                            <div class="form-group">
                                <label><strong>Damage Bonus (STR):</strong></label>
                                <select name="damageBonusStr" style="width: 100%">
                                    <option value="DoD.dice.none">None</option>
                                    <option value="DoD.dice.d4">D4</option>
                                    <option value="DoD.dice.d6">D6</option>
                                    <option value="DoD.dice.d8">D8</option>
                                    <option value="DoD.dice.d10">D10</option>
                                    <option value="DoD.dice.d12">D12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label><strong>Damage Bonus (AGL):</strong></label>
                                <select name="damageBonusAgl" style="width: 100%">
                                    <option value="DoD.dice.none">None</option>
                                    <option value="DoD.dice.d4">D4</option>
                                    <option value="DoD.dice.d6">D6</option>
                                    <option value="DoD.dice.d8">D8</option>
                                    <option value="DoD.dice.d10">D10</option>
                                    <option value="DoD.dice.d12">D12</option>
                                </select>
                            </div>
                        `);
            }
          }
        };

        html.find('[name="targetType"]').on("change", updateFields);
        updateFields(); // Initial call
      },
    },
    {
      width: 400,
      height: 300,
    }
  ).render(true);
})();

/**
 * Convert an actor from one type to another
 */
async function convertActor(sourceActor, targetType, newName, conversionData) {
  try {
    ui.notifications.info(`Converting ${sourceActor.name} to ${targetType}...`);

    // Get source actor data
    const sourceData = sourceActor.toObject();
    const sourceType = sourceActor.type;

    // Prepare new actor data structure
    let newActorData = {
      name: newName,
      type: targetType,
      img: sourceData.img,
      system: {},
      items: sourceData.items, // Transfer all items
      effects: sourceData.effects, // Transfer all active effects
    };

    // Convert based on source and target types
    if (sourceType === "character" && targetType === "npc") {
      newActorData.system = convertCharacterToNPC(sourceData.system);
    } else if (sourceType === "character" && targetType === "monster") {
      newActorData.system = convertCharacterToMonster(
        sourceData.system,
        conversionData
      );
    } else if (sourceType === "npc" && targetType === "character") {
      newActorData.system = convertNPCToCharacter(sourceData.system);
    } else if (sourceType === "npc" && targetType === "monster") {
      newActorData.system = convertNPCToMonster(
        sourceData.system,
        conversionData
      );
    } else if (sourceType === "monster" && targetType === "character") {
      newActorData.system = convertMonsterToCharacter(
        sourceData.system,
        conversionData
      );
    } else if (sourceType === "monster" && targetType === "npc") {
      newActorData.system = convertMonsterToNPC(
        sourceData.system,
        conversionData
      );
    }

    // Set token prototype settings based on target type
    newActorData.prototypeToken = getTokenPrototype(targetType);

    // Create the new actor
    const newActor = await Actor.create(newActorData);

    if (newActor) {
      ui.notifications.success(
        `Successfully converted ${sourceActor.name} to ${targetType}: ${newActor.name}`
      );

      // Optionally show the new actor sheet
      newActor.sheet.render(true);
    } else {
      ui.notifications.error("Failed to create new actor.");
    }
  } catch (error) {
    console.error("Actor conversion error:", error);
    ui.notifications.error(`Conversion failed: ${error.message}`);
  }
}

/**
 * Convert Character to NPC
 */
function convertCharacterToNPC(sourceSystem) {
  // Calculate damage bonuses from character attributes (NPCs don't have attributes)
  const strDmgBonus = calculateDamageBonus(sourceSystem.attributes.str.value);
  const aglDmgBonus = calculateDamageBonus(sourceSystem.attributes.agl.value);

  return {
    // Common fields
    description: sourceSystem.description || "",
    movement: sourceSystem.movement,
    hitPoints: sourceSystem.hitPoints,
    currency: sourceSystem.currency,
    encumbrance: sourceSystem.encumbrance,

    // Character-base fields (both have these)
    kin: sourceSystem.kin || "",
    age: sourceSystem.age || "adult",
    profession: sourceSystem.profession || "",
    motivation: sourceSystem.motivation || "",
    willPoints: sourceSystem.willPoints,

    // Calculate damage bonus from character's attributes
    damageBonus: {
      agl: {
        base: aglDmgBonus,
        value: aglDmgBonus,
      },
      str: {
        base: strDmgBonus,
        value: strDmgBonus,
      },
    },

    // NPC-specific fields (initialize as blank)
    traits: "",

    // DROP: attributes (NPCs don't have attributes)
    // DROP: deathRolls, canRestRound, canRestStretch (character-only)
    // DROP: appearance, weakness, notes, conditions, maxEncumbrance
  };
}

/**
 * Convert Character to Monster
 */
function convertCharacterToMonster(sourceSystem, conversionData) {
  return {
    // Common fields
    description: sourceSystem.description || "",
    movement: sourceSystem.movement,
    hitPoints: sourceSystem.hitPoints,
    currency: sourceSystem.currency,
    encumbrance: sourceSystem.encumbrance,

    // Monster-specific fields
    armor: conversionData.armor || 0,
    ferocity: {
      base: conversionData.ferocity || 1,
      value: conversionData.ferocity || 1,
    },
    size: conversionData.size || "normal",
    traits: "",
    attackTable: "",
    previousMonsterAttack: "",

    // DROP: attributes, willPoints, damageBonus, kin, profession, age, etc.
  };
}

/**
 * Convert NPC to Character
 */
function convertNPCToCharacter(sourceSystem) {
  // NPCs don't have attributes, so initialize with defaults
  // Character sheet will auto-calculate damage bonuses from attributes
  const defaultAttr = 10;

  return {
    // Common fields
    description: sourceSystem.description || "",
    movement: sourceSystem.movement,
    hitPoints: sourceSystem.hitPoints,
    currency: sourceSystem.currency,
    encumbrance: sourceSystem.encumbrance,

    // Character-base fields (both have these)
    kin: sourceSystem.kin || "",
    age: sourceSystem.age || "adult",
    profession: sourceSystem.profession || "",
    motivation: sourceSystem.motivation || "",
    willPoints: sourceSystem.willPoints,

    // Character-specific fields - initialize with defaults
    // Damage bonus will be auto-calculated by character sheet from attributes
    attributes: {
      str: { base: defaultAttr, value: defaultAttr },
      con: { base: defaultAttr, value: defaultAttr },
      agl: { base: defaultAttr, value: defaultAttr },
      int: { base: defaultAttr, value: defaultAttr },
      wil: { base: defaultAttr, value: defaultAttr },
      cha: { base: defaultAttr, value: defaultAttr },
    },
    conditions: {
      str: { value: false },
      con: { value: false },
      agl: { value: false },
      int: { value: false },
      wil: { value: false },
      cha: { value: false },
    },
    appearance: "",
    weakness: "",
    notes: "",
    deathRolls: {
      successes: 0,
      failures: 0,
    },
    canRestRound: true,
    canRestStretch: true,
    maxEncumbrance: {
      base: Math.ceil(0.5 * defaultAttr),
      value: Math.ceil(0.5 * defaultAttr),
    },

    // DROP: traits (NPC-only)
    // DROP: damageBonus (will be auto-calculated)
  };
}

/**
 * Convert NPC to Monster
 */
function convertNPCToMonster(sourceSystem, conversionData) {
  return {
    // Common fields
    description: sourceSystem.description || "",
    movement: sourceSystem.movement,
    hitPoints: sourceSystem.hitPoints,
    currency: sourceSystem.currency,
    encumbrance: sourceSystem.encumbrance,

    // Monster-specific fields
    armor: conversionData.armor || 0,
    ferocity: {
      base: conversionData.ferocity || 1,
      value: conversionData.ferocity || 1,
    },
    size: conversionData.size || "normal",
    traits: sourceSystem.traits || "", // NPC has traits, transfer it
    attackTable: "",
    previousMonsterAttack: "",

    // DROP: attributes (NPCs don't have attributes), willPoints, damageBonus, kin, profession, age, etc.
  };
}

/**
 * Convert Monster to Character
 */
function convertMonsterToCharacter(sourceSystem, conversionData) {
  const attrs = conversionData.attributes;

  return {
    // Common fields
    description: sourceSystem.description || "",
    movement: sourceSystem.movement,
    hitPoints: sourceSystem.hitPoints,
    currency: sourceSystem.currency,
    encumbrance: sourceSystem.encumbrance,

    // Character-base fields (initialize with defaults or converted values)
    kin: "",
    age: "adult",
    profession: "",
    motivation: "",
    willPoints: {
      value: attrs.wil,
      base: attrs.wil,
      max: attrs.wil,
    },
    damageBonus: {
      agl: {
        base: calculateDamageBonus(attrs.agl),
        value: calculateDamageBonus(attrs.agl),
      },
      str: {
        base: calculateDamageBonus(attrs.str),
        value: calculateDamageBonus(attrs.str),
      },
    },

    // Character-specific fields
    attributes: {
      str: { base: attrs.str, value: attrs.str },
      con: { base: attrs.con, value: attrs.con },
      agl: { base: attrs.agl, value: attrs.agl },
      int: { base: attrs.int, value: attrs.int },
      wil: { base: attrs.wil, value: attrs.wil },
      cha: { base: attrs.cha, value: attrs.cha },
    },
    conditions: {
      str: { value: false },
      con: { value: false },
      agl: { value: false },
      int: { value: false },
      wil: { value: false },
      cha: { value: false },
    },
    appearance: "",
    weakness: "",
    notes: sourceSystem.traits || "", // Transfer traits to notes
    deathRolls: {
      successes: 0,
      failures: 0,
    },
    canRestRound: true,
    canRestStretch: true,
    maxEncumbrance: {
      base: Math.ceil(0.5 * attrs.str),
      value: Math.ceil(0.5 * attrs.str),
    },

    // DROP: ferocity, armor (monster-specific), attackTable, size
  };
}

/**
 * Convert Monster to NPC
 */
function convertMonsterToNPC(sourceSystem, conversionData) {
  return {
    // Common fields
    description: sourceSystem.description || "",
    movement: sourceSystem.movement,
    hitPoints: sourceSystem.hitPoints,
    currency: sourceSystem.currency,
    encumbrance: sourceSystem.encumbrance,

    // Character-base fields
    kin: "",
    age: "adult",
    profession: "",
    motivation: "",
    willPoints: {
      value: conversionData.wil || 10,
      base: conversionData.wil || 10,
      max: conversionData.wil || 10,
    },
    // Use manually provided damage bonus values
    damageBonus: {
      agl: {
        base: conversionData.damageBonus.agl,
        value: conversionData.damageBonus.agl,
      },
      str: {
        base: conversionData.damageBonus.str,
        value: conversionData.damageBonus.str,
      },
    },

    // NPC-specific
    traits: sourceSystem.traits || "", // Transfer monster traits to NPC traits

    // DROP: attributes (NPCs don't have attributes)
    // DROP: ferocity, armor (monster-specific), attackTable, size
  };
}

/**
 * Calculate damage bonus string based on attribute value
 */
function calculateDamageBonus(attributeValue) {
  if (attributeValue <= 9) return "DoD.dice.none";
  if (attributeValue <= 12) return "DoD.dice.d4";
  if (attributeValue <= 16) return "DoD.dice.d6";
  return "DoD.dice.d8";
}

/**
 * Get appropriate token prototype settings for actor type
 */
function getTokenPrototype(actorType) {
  const baseSettings = {
    name: "",
    displayName: 20, // Hovered by Owner
    displayBars: 20, // Hovered by Owner
    bar1: { attribute: "hitPoints" },
  };

  switch (actorType) {
    case "character":
      return {
        ...baseSettings,
        actorLink: true,
        disposition: 1, // Friendly
        bar2: { attribute: "willPoints" },
        displayBars: 30, // Hovered by Anyone
        sight: { enabled: true },
      };
    case "npc":
      return {
        ...baseSettings,
        disposition: 0, // Neutral
      };
    case "monster":
      return {
        ...baseSettings,
        disposition: -1, // Hostile
      };
    default:
      return baseSettings;
  }
}
